---
title: "Phenotype QC [Continious Phenotype - Age of Onset]"
author: "Belinda Cornes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning=FALSE)

library("kableExtra")
library("knitr")
options(stringsAsFactors = FALSE)
library(data.table) 
library(tidyr)     
library(mclust)     
library(rhdf5)      
library(optparse)
library(dplyr)
library(cluster)
library(readxl)
library(psych)
library(tibble)
library(ggplot2)
library(reshape2)
library(qtl2)
#library(qtl)
library(abind)
library(pastecs)

setwd("/Users/corneb/Documents/MyJax/CS/Projects/Serreze/qc/workflowr/Serreze-T1D_Workflow")

```

### Loading Data

```{r data, echo=TRUE}

load("data/gm_allqc_7.batches_myo_mis.RData")

#gm_allqc
gm=gm_allqc
gm

pr <- readRDS("data/serreze_probs_allqc_7.batches_myo_mis.rds")
#pr <- readRDS("data/serreze_probs.rds")

```

### ICI Sick vs ICI EOI
* Myocarditis Status: Yes
* Murine MHC KO Status: Homo
* Drug Treatment(s): ICI
* Clinical Phenotype(s): Sick, EOI
* Covariates (Myocarditis Score, Age of Clinical Phenotype – if Null, either use 40 age at which surviving mice were end of incidence without clinical symptoms )

```{r Phenotype distribution11, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}

##extracting animals 
#Myocarditis Status
miceinfo <- gm$covar[gm$covar$"Myocarditis Status" == "YES",]
#table(miceinfo$group)
#MMurine MHC KO Status
miceinfo <- miceinfo[miceinfo$"Murine MHC KO Status" == "HOM",]
#Drug Treatment
miceinfo <- miceinfo[miceinfo$"Drug Treatment" == "ICI",]
#Clinical Phenotype
miceinfo <- miceinfo[miceinfo$"clinical pheno" == "SICK" | miceinfo$"clinical pheno" == "EOI",]

table(miceinfo$"Myocarditis Status")
table(miceinfo$"Murine MHC KO Status")
table(miceinfo$"Drug Treatment")
table(miceinfo$"clinical pheno")

mice.ids <- rownames(miceinfo)
mice.ids.original <- as.character(do.call(rbind.data.frame, strsplit(mice.ids, "_"))[,7])

##removing X samples
x.samples = c("NM00179-ICI-EOI","NM00186-ICI-EOI","D22-ICI-EOI","D39-ICI-Myo","D67-ICI-Myo","D111-PBS-Myo","D120-ICI-Myo","6895-PBS-Myo","D704-ICI-Myo")
mice.ids = mice.ids[!as.character(do.call(rbind.data.frame, strsplit(mice.ids, "_"))[,7]) %in% x.samples]

#removing duplicates
dup.samples = c("The_Jackson_Lab_Serreze_MURGIGV01_20230225_D249-PBS-EOI_H3")
mice.ids = mice.ids[!mice.ids %in% dup.samples]

gm <- gm[mice.ids]
gm


pr.qc <- pr
for (i in 1:20){pr.qc[[i]] = pr.qc[[i]][mice.ids,,]}

gm$covar$ici.sick_vs_ici.eoi <- ifelse(gm$covar$"clinical pheno" == "EOI", 0, 1)
names(gm$covar)[6] <- c("age.of.onset")
gm$covar$age.of.onset <- as.numeric(gm$covar$age.of.onset)
gm$covar[gm$covar$age.of.onset==0 | is.na(gm$covar$age.of.onset) | gm$covar$age.of.onset=="NA" ,]$age.of.onset = ""
gm$covar[gm$covar$age.of.onset=='' ,]$age.of.onset <- 40
gm$covar$age.of.onset <- as.numeric(gm$covar$age.of.onset)

p <- ggplot(gm$covar, aes(x=as.numeric(age.of.onset))) + geom_histogram(color="black", fill="white")
p

phenos.covars.lg <- gm$covar %>% gather(variable, value, -c("id","sex","sex_pheno","Inferred.Sex","Myocarditis Status","clinical pheno","Drug Treatment","Histology Score","Murine MHC KO Status","id_corrected","ici.sick_vs_ici.eoi"))

box1 <-  ggplot(data=phenos.covars.lg, aes(x=variable, y=as.numeric(value), color=interaction("Myocarditis Status","Drug Treatment","clinical pheno"), fill=interaction("Myocarditis Status","Drug Treatment","clinical pheno"))) +
         geom_boxplot(position = position_dodge(width=0.9)) +
         #ggtitle(paste0("Values of ",v," [random dataframe: ",r,"]")) +
         #labs(y = v) +
         theme(strip.text.x = element_text(size=13),
               axis.text.x = element_text(size = 13, angle = 0),
               axis.text.y = element_text(size = 13, angle = 0),  
               axis.title.x=element_blank(),
               axis.title.y=element_blank(),
               plot.title = element_text(size = 13, face = "bold",hjust = 0.5),
                  #legend.position = "none"
             )
box1


```
QTL analysis requires variables follow normal distribution, from the above distributions, we need to ranknorm the data.  


```{r Phenotype distribution12, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}

##ranknorm
rz.transform <- function(y) {
  rankY=rank(y, ties.method="average", na.last="keep")
  rzT=qnorm(rankY/(length(na.exclude(rankY))+1))
  return(rzT)
}

gm$covar$rz.age <- rz.transform(gm$covar$age.of.onset)

p <- ggplot(gm$covar, aes(x=as.numeric(rz.age))) + geom_histogram(color="black", fill="white")
p

phenos.covars.lg <- gm$covar %>% gather(variable, value, -c("id","sex","sex_pheno","Inferred.Sex","Myocarditis Status","clinical pheno","Drug Treatment","Histology Score","Murine MHC KO Status","id_corrected","ici.sick_vs_ici.eoi","age.of.onset"))

box1 <-  ggplot(data=phenos.covars.lg, aes(x=variable, y=as.numeric(value), color=interaction("Myocarditis Status","Drug Treatment","clinical pheno"), fill=interaction("Myocarditis Status","Drug Treatment","clinical pheno"))) +
         geom_boxplot(position = position_dodge(width=0.9)) +
         #ggtitle(paste0("Values of ",v," [random dataframe: ",r,"]")) +
         #labs(y = v) +
         theme(strip.text.x = element_text(size=13),
               axis.text.x = element_text(size = 13, angle = 0),
               axis.text.y = element_text(size = 13, angle = 0),  
               axis.title.x=element_blank(),
               axis.title.y=element_blank(),
               plot.title = element_text(size = 13, face = "bold",hjust = 0.5),
                  #legend.position = "none"
             )
box1


```

And then remove any samples that are 3 standard deviations from the mean. 

```{r outliers1, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}

#outliers
#des.3 <- Hmisc::describe(df_phenos[,c("R_AVG","L_AVG","Both_AVG")]) 
des.1 <- pastecs::stat.desc(gm$covar[,c("age.of.onset" ,"rz.age")]) 
des.2 <- psych::describe(gm$covar[,c("age.of.onset" ,"rz.age")]) 

#scale(df_phenos[,c("R_AVG")])

gm$covar$out.age.of.onset <- ifelse(gm$covar[,c("age.of.onset")] > (des.1[9,1] + 3*des.1[13,1])  | gm$covar[,c("age.of.onset")] < (des.1[9,1] - 3*des.1[13,1]), 'Outlier','Keep')
gm$covar$out.rz.age <- ifelse(gm$covar[,c("rz.age")] > (des.1[9,2] + 3*des.1[13,2])  | gm$covar[,c("rz.age")] < (des.1[9,2] - 3*des.1[13,2]), 'Outlier','Keep')

bad <- NULL
bad$Mouse.ID <- rownames(gm$covar)
bad$age.of.onset <- ifelse(gm$covar$out.age.of.onset =="Outlier", 'XX', '')
bad$rz.age <- ifelse(gm$covar$out.rz.age =="Outlier", 'XX', '')
bad[is.na(bad)] <- ""
bad[bad=='NA'] <- ""
df <- do.call(cbind, bad)
bad <- as.data.frame(df)

badind <- subset(bad, 
         bad$age.of.onset == 'XX'|
         bad$rz.age == 'XX')


#badind <- bad[bad$no_pheno == 'XX',]

badind[] <- lapply(badind, as.character)
#badind$Thaiss_ID <- ifelse(badind$Thaiss == 994 | badind$Thaiss == 995 | badind$Thaiss == 996 |badind$Thaiss == 997 | badind$Thaiss == 998 | badind$Thaiss == 999, "--", bad$Thaiss_ID)

rownames(badind) <- NULL

badind[] %>% 
   dplyr::mutate(
     age.of.onset = ifelse(age.of.onset == 'XX',
                  cell_spec(age.of.onset, color = 'gray',background = 'gray'),
                  ''),
     rz.age = ifelse(rz.age == 'XX',
                  cell_spec(rz.age, color = 'gray',background = 'gray'),
                  '')
     ) %>%
   kable(escape = F,align = c("ccccccccc"),linesep ="\\hline") %>%
   kable_styling("striped", full_width = F) #%>%
#   column_spec(1:3, width = "3cm") 


##removing outliers
gm$covar$Mouse.ID <- rownames(gm$covar)
write.csv(gm$covar,"data/covar_corrected_ici-sick.vs.ici-eoi_7.batches_myo_mis.csv", row.names=T, quote=F)

gm$covar$age.of.onset[gm$covar$out.age.of.onset == "Outlier"] <- '' 
gm$covar$rz.age[gm$covar$out.rz.age == "Outlier"] <- '' 

#gm$covar <- gm$covar[c(1:15)]
#gm$covar$id <- rownames(gm$covar)
write.csv(gm$covar,"data/covar_corrected.cleaned_ici-sick.vs.ici-eoi_7.batches_myo_mis.csv", row.names=T, quote=F)

```

That is, those that have a grey square were removed for that particular phenotype in the QTL mapping. 

### ICI vs PBS
* Myocarditis Status: Yes
* Murine MHC KO Status: Homo
* Drug Treatment(s): ICI, PBS
* Clinical Phenotype(s): Sick, EOI
* Covariates (Myocarditis Score, Age of Clinical Phenotype – if Null, use 40 age at which surviving mice were end of incidence without clinical symptoms)

```{r Phenotype distribution21, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}

gm=gm_allqc

##extracting animals 
#Myocarditis Status
miceinfo <- gm$covar[gm$covar$"Myocarditis Status" == "YES",]
#table(miceinfo$group)
#MMurine MHC KO Status
miceinfo <- miceinfo[miceinfo$"Murine MHC KO Status" == "HOM",]
#Drug Treatment
miceinfo <- miceinfo[miceinfo$"Drug Treatment" == "ICI" | miceinfo$"Drug Treatment" == "PBS",]
#Clinical Phenotype
miceinfo <- miceinfo[miceinfo$"clinical pheno" == "SICK" | miceinfo$"clinical pheno" == "EOI",]

table(miceinfo$"Myocarditis Status")
table(miceinfo$"Murine MHC KO Status")
table(miceinfo$"Drug Treatment")
table(miceinfo$"clinical pheno")

mice.ids <- rownames(miceinfo)

##removing X samples
x.samples = c("NM00179-ICI-EOI","NM00186-ICI-EOI","D22-ICI-EOI","D39-ICI-Myo","D67-ICI-Myo","D111-PBS-Myo","D120-ICI-Myo","6895-PBS-Myo","D704-ICI-Myo")
mice.ids = mice.ids[!as.character(do.call(rbind.data.frame, strsplit(mice.ids, "_"))[,7]) %in% x.samples]

#removing duplicates
dup.samples = c("The_Jackson_Lab_Serreze_MURGIGV01_20230225_D249-PBS-EOI_H3")
mice.ids = mice.ids[!mice.ids %in% dup.samples]

gm <- gm[mice.ids]
gm

pr.qc <- pr
for (i in 1:20){pr.qc[[i]] = pr.qc[[i]][mice.ids,,]}

gm$covar$ici_vs_pbs <- ifelse(gm$covar$"Drug Treatment" == "PBS", 0, 1)
names(gm$covar)[6] <- c("age.of.onset")
gm$covar$age.of.onset <- as.numeric(gm$covar$age.of.onset)
#if(0 %in% unique(gm$covar$age.of.onset)){
gm$covar[gm$covar$age.of.onset==0 | is.na(gm$covar$age.of.onset) | gm$covar$age.of.onset=="NA" ,]$age.of.onset = ""
gm$covar[gm$covar$age.of.onset=='' ,]$age.of.onset <- 40
gm$covar$age.of.onset <- as.numeric(gm$covar$age.of.onset)
#}

p <- ggplot(gm$covar, aes(x=as.numeric(age.of.onset))) + geom_histogram(color="black", fill="white")
p

phenos.covars.lg <- gm$covar %>% gather(variable, value, -c("id","sex","sex_pheno","Inferred.Sex","Myocarditis Status","clinical pheno","Drug Treatment","Histology Score","Murine MHC KO Status","id_corrected","ici_vs_pbs"))

box1 <-  ggplot(data=phenos.covars.lg, aes(x=variable, y=as.numeric(value), color=interaction("Myocarditis Status","Drug Treatment","clinical pheno"), fill=interaction("Myocarditis Status","Drug Treatment","clinical pheno"))) +
         geom_boxplot(position = position_dodge(width=0.9)) +
         #ggtitle(paste0("Values of ",v," [random dataframe: ",r,"]")) +
         #labs(y = v) +
         theme(strip.text.x = element_text(size=13),
               axis.text.x = element_text(size = 13, angle = 0),
               axis.text.y = element_text(size = 13, angle = 0),  
               axis.title.x=element_blank(),
               axis.title.y=element_blank(),
               plot.title = element_text(size = 13, face = "bold",hjust = 0.5),
                  #legend.position = "none"
             )
box1


```
QTL analysis requires variables follow normal distribution, from the above distributions, we need to ranknorm the data.  


```{r Phenotype distribution22, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}

##ranknorm
rz.transform <- function(y) {
  rankY=rank(y, ties.method="average", na.last="keep")
  rzT=qnorm(rankY/(length(na.exclude(rankY))+1))
  return(rzT)
}

gm$covar$rz.age <- rz.transform(gm$covar$age.of.onset)

p <- ggplot(gm$covar, aes(x=as.numeric(rz.age))) + geom_histogram(color="black", fill="white")
p

phenos.covars.lg <- gm$covar %>% gather(variable, value, -c("id","sex","sex_pheno","Inferred.Sex","Myocarditis Status","clinical pheno","Drug Treatment","Histology Score","Murine MHC KO Status","id_corrected","ici_vs_pbs","age.of.onset"))

box1 <-  ggplot(data=phenos.covars.lg, aes(x=variable, y=as.numeric(value), color=interaction("Myocarditis Status","Drug Treatment","clinical pheno"), fill=interaction("Myocarditis Status","Drug Treatment","clinical pheno"))) +
         geom_boxplot(position = position_dodge(width=0.9)) +
         #ggtitle(paste0("Values of ",v," [random dataframe: ",r,"]")) +
         #labs(y = v) +
         theme(strip.text.x = element_text(size=13),
               axis.text.x = element_text(size = 13, angle = 0),
               axis.text.y = element_text(size = 13, angle = 0),  
               axis.title.x=element_blank(),
               axis.title.y=element_blank(),
               plot.title = element_text(size = 13, face = "bold",hjust = 0.5),
                  #legend.position = "none"
             )
box1


```

And then remove any samples that are 3 standard deviations from the mean. 

```{r outliers2, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}


#outliers
#des.3 <- Hmisc::describe(df_phenos[,c("R_AVG","L_AVG","Both_AVG")]) 
des.1 <- pastecs::stat.desc(gm$covar[,c("age.of.onset" ,"rz.age")]) 
des.2 <- psych::describe(gm$covar[,c("age.of.onset" ,"rz.age")]) 

#scale(df_phenos[,c("R_AVG")])

gm$covar$out.age.of.onset <- ifelse(gm$covar[,c("age.of.onset")] > (des.1[9,1] + 3*des.1[13,1])  | gm$covar[,c("age.of.onset")] < (des.1[9,1] - 3*des.1[13,1]), 'Outlier','Keep')
gm$covar$out.rz.age <- ifelse(gm$covar[,c("rz.age")] > (des.1[9,2] + 3*des.1[13,2])  | gm$covar[,c("rz.age")] < (des.1[9,2] - 3*des.1[13,2]), 'Outlier','Keep')

bad <- NULL
bad$Mouse.ID <- rownames(gm$covar)
bad$age.of.onset <- ifelse(gm$covar$out.age.of.onset =="Outlier", 'XX', '')
bad$rz.age <- ifelse(gm$covar$out.rz.age =="Outlier", 'XX', '')
bad[is.na(bad)] <- ""
bad[bad=='NA'] <- ""
df <- do.call(cbind, bad)
bad <- as.data.frame(df)

badind <- subset(bad, 
         bad$age.of.onset == 'XX'|
         bad$rz.age == 'XX')


#badind <- bad[bad$no_pheno == 'XX',]

badind[] <- lapply(badind, as.character)
#badind$Thaiss_ID <- ifelse(badind$Thaiss == 994 | badind$Thaiss == 995 | badind$Thaiss == 996 |badind$Thaiss == 997 | badind$Thaiss == 998 | badind$Thaiss == 999, "--", bad$Thaiss_ID)

rownames(badind) <- NULL

badind[] %>% 
   dplyr::mutate(
     age.of.onset = ifelse(age.of.onset == 'XX',
                  cell_spec(age.of.onset, color = 'gray',background = 'gray'),
                  ''),
     rz.age = ifelse(rz.age == 'XX',
                  cell_spec(rz.age, color = 'gray',background = 'gray'),
                  '')
     ) %>%
   kable(escape = F,align = c("ccccccccc"),linesep ="\\hline") %>%
   kable_styling("striped", full_width = F) #%>%
#   column_spec(1:3, width = "3cm") 


##removing outliers
gm$covar$Mouse.ID <- rownames(gm$covar)
write.csv(gm$covar,"data/covar_corrected_ici.vs.pbs_7.batches_myo_mis.csv", row.names=T, quote=F)

gm$covar$age.of.onset[gm$covar$out.age.of.onset == "Outlier"] <- '' 
gm$covar$rz.age[gm$covar$out.rz.age == "Outlier"] <- '' 

#gm$covar <- gm$covar[c(1:15)]
#gm$covar$id <- rownames(gm$covar)
write.csv(gm$covar,"data/covar_corrected.cleaned_ici.vs.pbs_7.batches_myo_mis.csv", row.names=T, quote=F)

```

### ICI Myocarditis Yes vs ICI Myocarditis No
* Myocarditis Status: Yes, No
* Murine MHC KO Status: Homo
* Drug Treatment(s): ICI
* Clinical Phenotype(s): Sick, EOI
* Covariates (Myocarditis Score)

```{r Phenotype distribution31, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}

gm=gm_allqc

##extracting animals 
#Myocarditis Status
miceinfo <- gm$covar[gm$covar$"Myocarditis Status" == "YES" | gm$covar$"Myocarditis Status" == "NO",]
#table(miceinfo$group)
#MMurine MHC KO Status
miceinfo <- miceinfo[miceinfo$"Murine MHC KO Status" == "HOM",]
#Drug Treatment
miceinfo <- miceinfo[miceinfo$"Drug Treatment" == "ICI",]
#Clinical Phenotype
miceinfo <- miceinfo[miceinfo$"clinical pheno" == "SICK" | miceinfo$"clinical pheno" == "EOI",]

table(miceinfo$"Myocarditis Status")
table(miceinfo$"Murine MHC KO Status")
table(miceinfo$"Drug Treatment")
table(miceinfo$"clinical pheno")

mice.ids <- rownames(miceinfo)

##removing X samples
x.samples = c("NM00179-ICI-EOI","NM00186-ICI-EOI","D22-ICI-EOI","D39-ICI-Myo","D67-ICI-Myo","D111-PBS-Myo","D120-ICI-Myo","6895-PBS-Myo","D704-ICI-Myo")
mice.ids = mice.ids[!as.character(do.call(rbind.data.frame, strsplit(mice.ids, "_"))[,7]) %in% x.samples]

#removing duplicates
dup.samples = c("The_Jackson_Lab_Serreze_MURGIGV01_20230225_D249-PBS-EOI_H3")
mice.ids = mice.ids[!mice.ids %in% dup.samples]

gm <- gm[mice.ids]
gm

pr.qc <- pr
for (i in 1:20){pr.qc[[i]] = pr.qc[[i]][mice.ids,,]}

gm$covar$ici.myo.yes_vs_ici.myo.no <- ifelse(gm$covar$"Myocarditis Status" == "NO", 0, 1)
names(gm$covar)[6] <- c("age.of.onset")
gm$covar$age.of.onset <- as.numeric(gm$covar$age.of.onset)
gm$covar[gm$covar$age.of.onset==0 | is.na(gm$covar$age.of.onset) | gm$covar$age.of.onset=="NA" ,]$age.of.onset = ""
gm$covar[gm$covar$age.of.onset=='' ,]$age.of.onset <- 40
gm$covar$age.of.onset <- as.numeric(gm$covar$age.of.onset)

p <- ggplot(gm$covar, aes(x=as.numeric(age.of.onset))) + geom_histogram(color="black", fill="white")
p

phenos.covars.lg <- gm$covar %>% gather(variable, value, -c("id","sex","sex_pheno","Inferred.Sex","Myocarditis Status","clinical pheno","Drug Treatment","Histology Score","Murine MHC KO Status","id_corrected","ici.myo.yes_vs_ici.myo.no"))

box1 <-  ggplot(data=phenos.covars.lg, aes(x=variable, y=as.numeric(value), color=interaction("Myocarditis Status","Drug Treatment","clinical pheno"), fill=interaction("Myocarditis Status","Drug Treatment","clinical pheno"))) +
         geom_boxplot(position = position_dodge(width=0.9)) +
         #ggtitle(paste0("Values of ",v," [random dataframe: ",r,"]")) +
         #labs(y = v) +
         theme(strip.text.x = element_text(size=13),
               axis.text.x = element_text(size = 13, angle = 0),
               axis.text.y = element_text(size = 13, angle = 0),  
               axis.title.x=element_blank(),
               axis.title.y=element_blank(),
               plot.title = element_text(size = 13, face = "bold",hjust = 0.5),
                  #legend.position = "none"
             )
box1


```
QTL analysis requires variables follow normal distribution, from the above distributions, we need to ranknorm the data.  


```{r Phenotype distribution32, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}

##ranknorm
rz.transform <- function(y) {
  rankY=rank(y, ties.method="average", na.last="keep")
  rzT=qnorm(rankY/(length(na.exclude(rankY))+1))
  return(rzT)
}

gm$covar$rz.age <- rz.transform(gm$covar$age.of.onset)

p <- ggplot(gm$covar, aes(x=as.numeric(rz.age))) + geom_histogram(color="black", fill="white")
p

phenos.covars.lg <- gm$covar %>% gather(variable, value, -c("id","sex","sex_pheno","Inferred.Sex","Myocarditis Status","clinical pheno","Drug Treatment","Histology Score","Murine MHC KO Status","id_corrected","ici.myo.yes_vs_ici.myo.no","age.of.onset"))

box1 <-  ggplot(data=phenos.covars.lg, aes(x=variable, y=as.numeric(value), color=interaction("Myocarditis Status","Drug Treatment","clinical pheno"), fill=interaction("Myocarditis Status","Drug Treatment","clinical pheno"))) +
         geom_boxplot(position = position_dodge(width=0.9)) +
         #ggtitle(paste0("Values of ",v," [random dataframe: ",r,"]")) +
         #labs(y = v) +
         theme(strip.text.x = element_text(size=13),
               axis.text.x = element_text(size = 13, angle = 0),
               axis.text.y = element_text(size = 13, angle = 0),  
               axis.title.x=element_blank(),
               axis.title.y=element_blank(),
               plot.title = element_text(size = 13, face = "bold",hjust = 0.5),
                  #legend.position = "none"
             )
box1


```

And then remove any samples that are 3 standard deviations from the mean. 

```{r outliers3, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}


#outliers
#des.3 <- Hmisc::describe(df_phenos[,c("R_AVG","L_AVG","Both_AVG")]) 
des.1 <- pastecs::stat.desc(gm$covar[,c("age.of.onset" ,"rz.age")]) 
des.2 <- psych::describe(gm$covar[,c("age.of.onset" ,"rz.age")]) 

#scale(df_phenos[,c("R_AVG")])

gm$covar$out.age.of.onset <- ifelse(gm$covar[,c("age.of.onset")] > (des.1[9,1] + 3*des.1[13,1])  | gm$covar[,c("age.of.onset")] < (des.1[9,1] - 3*des.1[13,1]), 'Outlier','Keep')
gm$covar$out.rz.age <- ifelse(gm$covar[,c("rz.age")] > (des.1[9,2] + 3*des.1[13,2])  | gm$covar[,c("rz.age")] < (des.1[9,2] - 3*des.1[13,2]), 'Outlier','Keep')

bad <- NULL
bad$Mouse.ID <- rownames(gm$covar)
bad$age.of.onset <- ifelse(gm$covar$out.age.of.onset =="Outlier", 'XX', '')
bad$rz.age <- ifelse(gm$covar$out.rz.age =="Outlier", 'XX', '')
bad[is.na(bad)] <- ""
bad[bad=='NA'] <- ""
df <- do.call(cbind, bad)
bad <- as.data.frame(df)

badind <- subset(bad, 
         bad$age.of.onset == 'XX'|
         bad$rz.age == 'XX')


#badind <- bad[bad$no_pheno == 'XX',]

badind[] <- lapply(badind, as.character)
#badind$Thaiss_ID <- ifelse(badind$Thaiss == 994 | badind$Thaiss == 995 | badind$Thaiss == 996 |badind$Thaiss == 997 | badind$Thaiss == 998 | badind$Thaiss == 999, "--", bad$Thaiss_ID)

rownames(badind) <- NULL

badind[] %>% 
   dplyr::mutate(
     age.of.onset = ifelse(age.of.onset == 'XX',
                  cell_spec(age.of.onset, color = 'gray',background = 'gray'),
                  ''),
     rz.age = ifelse(rz.age == 'XX',
                  cell_spec(rz.age, color = 'gray',background = 'gray'),
                  '')
     ) %>%
   kable(escape = F,align = c("ccccccccc"),linesep ="\\hline") %>%
   kable_styling("striped", full_width = F) #%>%
#   column_spec(1:3, width = "3cm") 


##removing outliers
gm$covar$Mouse.ID <- rownames(gm$covar)
write.csv(gm$covar,"data/covar_corrected_ici-myo-yes.vs.ici-myo-no_7.batches_myo_mis.csv", row.names=T, quote=F)

gm$covar$age.of.onset[gm$covar$out.age.of.onset == "Outlier"] <- '' 
gm$covar$rz.age[gm$covar$out.rz.age == "Outlier"] <- '' 

#gm$covar <- gm$covar[c(1:15)]
#gm$covar$id <- rownames(gm$covar)
write.csv(gm$covar,"data/covar_corrected.cleaned_ici-myo-yes.vs.ici-myo-no_7.batches_myo_mis.csv", row.names=T, quote=F)

```

### PBS Myocarditis Yes vs PBS Myocarditis No
* Myocarditis Status: Yes, No
* Murine MHC KO Status: Homo
* Drug Treatment(s): PBS
* Clinical Phenotype(s): Sick, EOI
* Covariates (Myocarditis Score)

```{r Phenotype distribution41, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}

gm=gm_allqc

##extracting animals 
#Myocarditis Status
miceinfo <- gm$covar[gm$covar$"Myocarditis Status" == "YES" | gm$covar$"Myocarditis Status" == "NO",]
#table(miceinfo$group)
#MMurine MHC KO Status
miceinfo <- miceinfo[miceinfo$"Murine MHC KO Status" == "HOM",]
#Drug Treatment
miceinfo <- miceinfo[miceinfo$"Drug Treatment" == "PBS",]
#Clinical Phenotype
miceinfo <- miceinfo[miceinfo$"clinical pheno" == "SICK" | miceinfo$"clinical pheno" == "EOI",]

table(miceinfo$"Myocarditis Status")
table(miceinfo$"Murine MHC KO Status")
table(miceinfo$"Drug Treatment")
table(miceinfo$"clinical pheno")

mice.ids <- rownames(miceinfo)

##removing X samples
x.samples = c("NM00179-ICI-EOI","NM00186-ICI-EOI","D22-ICI-EOI","D39-ICI-Myo","D67-ICI-Myo","D111-PBS-Myo","D120-ICI-Myo","6895-PBS-Myo","D704-ICI-Myo")
mice.ids = mice.ids[!as.character(do.call(rbind.data.frame, strsplit(mice.ids, "_"))[,7]) %in% x.samples]

#removing duplicates
dup.samples = c("The_Jackson_Lab_Serreze_MURGIGV01_20230225_D249-PBS-EOI_H3")
mice.ids = mice.ids[!mice.ids %in% dup.samples]

gm <- gm[mice.ids]
gm

pr.qc <- pr
for (i in 1:20){pr.qc[[i]] = pr.qc[[i]][mice.ids,,]}

gm$covar$pbs.myo.yes_vs_pbs.myo.no <- ifelse(gm$covar$"Myocarditis Status" == "NO", 0, 1)
names(gm$covar)[6] <- c("age.of.onset")
gm$covar$age.of.onset <- as.numeric(gm$covar$age.of.onset)
gm$covar[gm$covar$age.of.onset==0 | is.na(gm$covar$age.of.onset) | gm$covar$age.of.onset=="NA" ,]$age.of.onset = ""
gm$covar[gm$covar$age.of.onset=='' ,]$age.of.onset <- 40
gm$covar$age.of.onset <- as.numeric(gm$covar$age.of.onset)

p <- ggplot(gm$covar, aes(x=as.numeric(age.of.onset))) + geom_histogram(color="black", fill="white")
p

phenos.covars.lg <- gm$covar %>% gather(variable, value, -c("id","sex","sex_pheno","Inferred.Sex","Myocarditis Status","clinical pheno","Drug Treatment","Histology Score","Murine MHC KO Status","id_corrected","pbs.myo.yes_vs_pbs.myo.no"))

box1 <-  ggplot(data=phenos.covars.lg, aes(x=variable, y=as.numeric(value), color=interaction("Myocarditis Status","Drug Treatment","clinical pheno"), fill=interaction("Myocarditis Status","Drug Treatment","clinical pheno"))) +
         geom_boxplot(position = position_dodge(width=0.9)) +
         #ggtitle(paste0("Values of ",v," [random dataframe: ",r,"]")) +
         #labs(y = v) +
         theme(strip.text.x = element_text(size=13),
               axis.text.x = element_text(size = 13, angle = 0),
               axis.text.y = element_text(size = 13, angle = 0),  
               axis.title.x=element_blank(),
               axis.title.y=element_blank(),
               plot.title = element_text(size = 13, face = "bold",hjust = 0.5),
                  #legend.position = "none"
             )
box1


```
QTL analysis requires variables follow normal distribution, from the above distributions, we need to ranknorm the data.  


```{r Phenotype distribution24, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}

##ranknorm
rz.transform <- function(y) {
  rankY=rank(y, ties.method="average", na.last="keep")
  rzT=qnorm(rankY/(length(na.exclude(rankY))+1))
  return(rzT)
}

gm$covar$rz.age <- rz.transform(gm$covar$age.of.onset)

p <- ggplot(gm$covar, aes(x=as.numeric(rz.age))) + geom_histogram(color="black", fill="white")
p

phenos.covars.lg <- gm$covar %>% gather(variable, value, -c("id","sex","sex_pheno","Inferred.Sex","Myocarditis Status","clinical pheno","Drug Treatment","Histology Score","Murine MHC KO Status","id_corrected","pbs.myo.yes_vs_pbs.myo.no","age.of.onset"))

box1 <-  ggplot(data=phenos.covars.lg, aes(x=variable, y=as.numeric(value), color=interaction("Myocarditis Status","Drug Treatment","clinical pheno"), fill=interaction("Myocarditis Status","Drug Treatment","clinical pheno"))) +
         geom_boxplot(position = position_dodge(width=0.9)) +
         #ggtitle(paste0("Values of ",v," [random dataframe: ",r,"]")) +
         #labs(y = v) +
         theme(strip.text.x = element_text(size=13),
               axis.text.x = element_text(size = 13, angle = 0),
               axis.text.y = element_text(size = 13, angle = 0),  
               axis.title.x=element_blank(),
               axis.title.y=element_blank(),
               plot.title = element_text(size = 13, face = "bold",hjust = 0.5),
                  #legend.position = "none"
             )
box1


```

And then remove any samples that are 3 standard deviations from the mean. 

```{r outliers4, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}


#outliers
#des.3 <- Hmisc::describe(df_phenos[,c("R_AVG","L_AVG","Both_AVG")]) 
des.1 <- pastecs::stat.desc(gm$covar[,c("age.of.onset" ,"rz.age")]) 
des.2 <- psych::describe(gm$covar[,c("age.of.onset" ,"rz.age")]) 

#scale(df_phenos[,c("R_AVG")])

gm$covar$out.age.of.onset <- ifelse(gm$covar[,c("age.of.onset")] > (des.1[9,1] + 3*des.1[13,1])  | gm$covar[,c("age.of.onset")] < (des.1[9,1] - 3*des.1[13,1]), 'Outlier','Keep')
gm$covar$out.rz.age <- ifelse(gm$covar[,c("rz.age")] > (des.1[9,2] + 3*des.1[13,2])  | gm$covar[,c("rz.age")] < (des.1[9,2] - 3*des.1[13,2]), 'Outlier','Keep')

bad <- NULL
bad$Mouse.ID <- rownames(gm$covar)
bad$age.of.onset <- ifelse(gm$covar$out.age.of.onset =="Outlier", 'XX', '')
bad$rz.age <- ifelse(gm$covar$out.rz.age =="Outlier", 'XX', '')
bad[is.na(bad)] <- ""
bad[bad=='NA'] <- ""
df <- do.call(cbind, bad)
bad <- as.data.frame(df)

badind <- subset(bad, 
         bad$age.of.onset == 'XX'|
         bad$rz.age == 'XX')


#badind <- bad[bad$no_pheno == 'XX',]

badind[] <- lapply(badind, as.character)
#badind$Thaiss_ID <- ifelse(badind$Thaiss == 994 | badind$Thaiss == 995 | badind$Thaiss == 996 |badind$Thaiss == 997 | badind$Thaiss == 998 | badind$Thaiss == 999, "--", bad$Thaiss_ID)

rownames(badind) <- NULL

badind[] %>% 
   dplyr::mutate(
     age.of.onset = ifelse(age.of.onset == 'XX',
                  cell_spec(age.of.onset, color = 'gray',background = 'gray'),
                  ''),
     rz.age = ifelse(rz.age == 'XX',
                  cell_spec(rz.age, color = 'gray',background = 'gray'),
                  '')
     ) %>%
   kable(escape = F,align = c("ccccccccc"),linesep ="\\hline") %>%
   kable_styling("striped", full_width = F) #%>%
#   column_spec(1:3, width = "3cm") 


##removing outliers
gm$covar$Mouse.ID <- rownames(gm$covar)
write.csv(gm$covar,"data/covar_corrected_pbs-myo-yes.vs.pbs-myo-no_7.batches_myo_mis.csv", row.names=T, quote=F)

gm$covar$age.of.onset[gm$covar$out.age.of.onset == "Outlier"] <- '' 
gm$covar$rz.age[gm$covar$out.rz.age == "Outlier"] <- '' 

#gm$covar <- gm$covar[c(1:15)]
#gm$covar$id <- rownames(gm$covar)
write.csv(gm$covar,"data/covar_corrected.cleaned_pbs-myo-yes.vs.pbs-myo-no_7.batches_myo_mis.csv", row.names=T, quote=F)

```

### Myocarditis Yes vs Myocarditis No
* Myocarditis Status: Yes, No
* Murine MHC KO Status: Homo
* Clinical Phenotype(s): Sick, EOI
* Covariates (Myocarditis Score)

```{r Phenotype distribution5, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}

gm=gm_allqc

##extracting animals 
#Myocarditis Status
miceinfo <- gm$covar[gm$covar$"Myocarditis Status" == "YES" | gm$covar$"Myocarditis Status" == "NO",]
#table(miceinfo$group)
#MMurine MHC KO Status
miceinfo <- miceinfo[miceinfo$"Murine MHC KO Status" == "HOM",]
#Drug Treatment
#miceinfo <- miceinfo[miceinfo$"Drug Treatment" == "PBS",]
#Clinical Phenotype
miceinfo <- miceinfo[miceinfo$"clinical pheno" == "SICK" | miceinfo$"clinical pheno" == "EOI",]

table(miceinfo$"Myocarditis Status")
table(miceinfo$"Murine MHC KO Status")
table(miceinfo$"Drug Treatment")
table(miceinfo$"clinical pheno")

mice.ids <- rownames(miceinfo)

##removing X samples
x.samples = c("NM00179-ICI-EOI","NM00186-ICI-EOI","D22-ICI-EOI","D39-ICI-Myo","D67-ICI-Myo","D111-PBS-Myo","D120-ICI-Myo","6895-PBS-Myo","D704-ICI-Myo")
mice.ids = mice.ids[!as.character(do.call(rbind.data.frame, strsplit(mice.ids, "_"))[,7]) %in% x.samples]

#removing duplicates
dup.samples = c("The_Jackson_Lab_Serreze_MURGIGV01_20230225_D249-PBS-EOI_H3")
mice.ids = mice.ids[!mice.ids %in% dup.samples]

gm <- gm[mice.ids]
gm

pr.qc <- pr
for (i in 1:20){pr.qc[[i]] = pr.qc[[i]][mice.ids,,]}

gm$covar$myo.yes_vs_myo.no <- ifelse(gm$covar$"Myocarditis Status" == "NO", 0, 1)
names(gm$covar)[6] <- c("age.of.onset")
gm$covar$age.of.onset <- as.numeric(gm$covar$age.of.onset)
gm$covar[gm$covar$age.of.onset==0 | is.na(gm$covar$age.of.onset) | gm$covar$age.of.onset=="NA" ,]$age.of.onset = ""
gm$covar[gm$covar$age.of.onset=='' ,]$age.of.onset <- 40
gm$covar$age.of.onset <- as.numeric(gm$covar$age.of.onset)

p <- ggplot(gm$covar, aes(x=as.numeric(age.of.onset))) + geom_histogram(color="black", fill="white")
p

phenos.covars.lg <- gm$covar %>% gather(variable, value, -c("id","sex","sex_pheno","Inferred.Sex","Myocarditis Status","clinical pheno","Drug Treatment","Histology Score","Murine MHC KO Status","id_corrected","myo.yes_vs_myo.no"))

box1 <-  ggplot(data=phenos.covars.lg, aes(x=variable, y=as.numeric(value), color=interaction("Myocarditis Status","Drug Treatment","clinical pheno"), fill=interaction("Myocarditis Status","Drug Treatment","clinical pheno"))) +
         geom_boxplot(position = position_dodge(width=0.9)) +
         #ggtitle(paste0("Values of ",v," [random dataframe: ",r,"]")) +
         #labs(y = v) +
         theme(strip.text.x = element_text(size=13),
               axis.text.x = element_text(size = 13, angle = 0),
               axis.text.y = element_text(size = 13, angle = 0),  
               axis.title.x=element_blank(),
               axis.title.y=element_blank(),
               plot.title = element_text(size = 13, face = "bold",hjust = 0.5),
                  #legend.position = "none"
             )
box1


```
QTL analysis requires variables follow normal distribution, from the above distributions, we need to ranknorm the data.  


```{r Phenotype distribution25, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}

##ranknorm
rz.transform <- function(y) {
  rankY=rank(y, ties.method="average", na.last="keep")
  rzT=qnorm(rankY/(length(na.exclude(rankY))+1))
  return(rzT)
}

gm$covar$rz.age <- rz.transform(gm$covar$age.of.onset)

p <- ggplot(gm$covar, aes(x=as.numeric(rz.age))) + geom_histogram(color="black", fill="white")
p

phenos.covars.lg <- gm$covar %>% gather(variable, value, -c("id","sex","sex_pheno","Inferred.Sex","Myocarditis Status","clinical pheno","Drug Treatment","Histology Score","Murine MHC KO Status","id_corrected","myo.yes_vs_myo.no","age.of.onset"))

box1 <-  ggplot(data=phenos.covars.lg, aes(x=variable, y=as.numeric(value), color=interaction("Myocarditis Status","Drug Treatment","clinical pheno"), fill=interaction("Myocarditis Status","Drug Treatment","clinical pheno"))) +
         geom_boxplot(position = position_dodge(width=0.9)) +
         #ggtitle(paste0("Values of ",v," [random dataframe: ",r,"]")) +
         #labs(y = v) +
         theme(strip.text.x = element_text(size=13),
               axis.text.x = element_text(size = 13, angle = 0),
               axis.text.y = element_text(size = 13, angle = 0),  
               axis.title.x=element_blank(),
               axis.title.y=element_blank(),
               plot.title = element_text(size = 13, face = "bold",hjust = 0.5),
                  #legend.position = "none"
             )
box1


```

And then remove any samples that are 3 standard deviations from the mean. 

```{r outliers5, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}


#outliers
#des.3 <- Hmisc::describe(df_phenos[,c("R_AVG","L_AVG","Both_AVG")]) 
des.1 <- pastecs::stat.desc(gm$covar[,c("age.of.onset" ,"rz.age")]) 
des.2 <- psych::describe(gm$covar[,c("age.of.onset" ,"rz.age")]) 

#scale(df_phenos[,c("R_AVG")])

gm$covar$out.age.of.onset <- ifelse(gm$covar[,c("age.of.onset")] > (des.1[9,1] + 3*des.1[13,1])  | gm$covar[,c("age.of.onset")] < (des.1[9,1] - 3*des.1[13,1]), 'Outlier','Keep')
gm$covar$out.rz.age <- ifelse(gm$covar[,c("rz.age")] > (des.1[9,2] + 3*des.1[13,2])  | gm$covar[,c("rz.age")] < (des.1[9,2] - 3*des.1[13,2]), 'Outlier','Keep')

bad <- NULL
bad$Mouse.ID <- rownames(gm$covar)
bad$age.of.onset <- ifelse(gm$covar$out.age.of.onset =="Outlier", 'XX', '')
bad$rz.age <- ifelse(gm$covar$out.rz.age =="Outlier", 'XX', '')
bad[is.na(bad)] <- ""
bad[bad=='NA'] <- ""
df <- do.call(cbind, bad)
bad <- as.data.frame(df)

badind <- subset(bad, 
         bad$age.of.onset == 'XX'|
         bad$rz.age == 'XX')


#badind <- bad[bad$no_pheno == 'XX',]

badind[] <- lapply(badind, as.character)
#badind$Thaiss_ID <- ifelse(badind$Thaiss == 994 | badind$Thaiss == 995 | badind$Thaiss == 996 |badind$Thaiss == 997 | badind$Thaiss == 998 | badind$Thaiss == 999, "--", bad$Thaiss_ID)

rownames(badind) <- NULL

badind[] %>% 
   dplyr::mutate(
     age.of.onset = ifelse(age.of.onset == 'XX',
                  cell_spec(age.of.onset, color = 'gray',background = 'gray'),
                  ''),
     rz.age = ifelse(rz.age == 'XX',
                  cell_spec(rz.age, color = 'gray',background = 'gray'),
                  '')
     ) %>%
   kable(escape = F,align = c("ccccccccc"),linesep ="\\hline") %>%
   kable_styling("striped", full_width = F) #%>%
#   column_spec(1:3, width = "3cm") 


##removing outliers
gm$covar$Mouse.ID <- rownames(gm$covar)
write.csv(gm$covar,"data/covar_corrected_myo-yes.vs.myo-no_7.batches_myo_mis.csv", row.names=T, quote=F)

gm$covar$age.of.onset[gm$covar$out.age.of.onset == "Outlier"] <- '' 
gm$covar$rz.age[gm$covar$out.rz.age == "Outlier"] <- '' 

#gm$covar <- gm$covar[c(1:15)]
#gm$covar$id <- rownames(gm$covar)
write.csv(gm$covar,"data/covar_corrected.cleaned_myo-yes.vs.myo-no_7.batches_myo_mis.csv", row.names=T, quote=F)

```

### Hetero: ICI vs PBS
* Myocarditis Status: Yes
* Murine MHC KO Status: Het
* Drug Treatment(s): ICI, PBS
* Clinical Phenotype(s): Sick, EOI
* Covariates (Myocarditis Score, Age of Clinical Phenotype – if Null, use 40 age at which surviving mice were end of incidence without clinical symptoms)

```{r Phenotype distribution6, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}

gm=gm_allqc

##extracting animals 
#Myocarditis Status
miceinfo <- gm$covar[gm$covar$"Myocarditis Status" == "YES",]
#table(miceinfo$group)
#MMurine MHC KO Status
miceinfo <- miceinfo[miceinfo$"Murine MHC KO Status" == "HET",]
#Drug Treatment
miceinfo <- miceinfo[miceinfo$"Drug Treatment" == "PBS" | miceinfo$"Drug Treatment" == "ICI",]
#Clinical Phenotype
miceinfo <- miceinfo[miceinfo$"clinical pheno" == "SICK" | miceinfo$"clinical pheno" == "EOI",]

table(miceinfo$"Myocarditis Status")
table(miceinfo$"Murine MHC KO Status")
table(miceinfo$"Drug Treatment")
table(miceinfo$"clinical pheno")

mice.ids <- rownames(miceinfo)

##removing X samples
x.samples = c("NM00179-ICI-EOI","NM00186-ICI-EOI","D22-ICI-EOI","D39-ICI-Myo","D67-ICI-Myo","D111-PBS-Myo","D120-ICI-Myo","6895-PBS-Myo","D704-ICI-Myo")
mice.ids = mice.ids[!as.character(do.call(rbind.data.frame, strsplit(mice.ids, "_"))[,7]) %in% x.samples]

#removing duplicates
dup.samples = c("The_Jackson_Lab_Serreze_MURGIGV01_20230225_D249-PBS-EOI_H3")
mice.ids = mice.ids[!mice.ids %in% dup.samples]

gm <- gm[mice.ids]
gm

pr.qc <- pr
for (i in 1:20){pr.qc[[i]] = pr.qc[[i]][mice.ids,,]}

gm$covar$het.ici_vs_het.pbs <- ifelse(gm$covar$"Drug Treatment" == "PBS", 0, 1)
names(gm$covar)[6] <- c("age.of.onset")
gm$covar$age.of.onset <- as.numeric(gm$covar$age.of.onset)
gm$covar[gm$covar$age.of.onset==0 | is.na(gm$covar$age.of.onset) | gm$covar$age.of.onset=="NA" ,]$age.of.onset = ""
gm$covar[gm$covar$age.of.onset=='' ,]$age.of.onset <- 40
gm$covar$age.of.onset <- as.numeric(gm$covar$age.of.onset)

p <- ggplot(gm$covar, aes(x=as.numeric(age.of.onset))) + geom_histogram(color="black", fill="white")
p

phenos.covars.lg <- gm$covar %>% gather(variable, value, -c("id","sex","sex_pheno","Inferred.Sex","Myocarditis Status","clinical pheno","Drug Treatment","Histology Score","Murine MHC KO Status","id_corrected","het.ici_vs_het.pbs"))

box1 <-  ggplot(data=phenos.covars.lg, aes(x=variable, y=as.numeric(value), color=interaction("Myocarditis Status","Drug Treatment","clinical pheno"), fill=interaction("Myocarditis Status","Drug Treatment","clinical pheno"))) +
         geom_boxplot(position = position_dodge(width=0.9)) +
         #ggtitle(paste0("Values of ",v," [random dataframe: ",r,"]")) +
         #labs(y = v) +
         theme(strip.text.x = element_text(size=13),
               axis.text.x = element_text(size = 13, angle = 0),
               axis.text.y = element_text(size = 13, angle = 0),  
               axis.title.x=element_blank(),
               axis.title.y=element_blank(),
               plot.title = element_text(size = 13, face = "bold",hjust = 0.5),
                  #legend.position = "none"
             )
box1


```
QTL analysis requires variables follow normal distribution, from the above distributions, we need to ranknorm the data.  


```{r Phenotype distribution26, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}

##ranknorm
rz.transform <- function(y) {
  rankY=rank(y, ties.method="average", na.last="keep")
  rzT=qnorm(rankY/(length(na.exclude(rankY))+1))
  return(rzT)
}

gm$covar$rz.age <- rz.transform(gm$covar$age.of.onset)

p <- ggplot(gm$covar, aes(x=as.numeric(rz.age))) + geom_histogram(color="black", fill="white")
p

phenos.covars.lg <- gm$covar %>% gather(variable, value, -c("id","sex","sex_pheno","Inferred.Sex","Myocarditis Status","clinical pheno","Drug Treatment","Histology Score","Murine MHC KO Status","id_corrected","het.ici_vs_het.pbs","age.of.onset"))

box1 <-  ggplot(data=phenos.covars.lg, aes(x=variable, y=as.numeric(value), color=interaction("Myocarditis Status","Drug Treatment","clinical pheno"), fill=interaction("Myocarditis Status","Drug Treatment","clinical pheno"))) +
         geom_boxplot(position = position_dodge(width=0.9)) +
         #ggtitle(paste0("Values of ",v," [random dataframe: ",r,"]")) +
         #labs(y = v) +
         theme(strip.text.x = element_text(size=13),
               axis.text.x = element_text(size = 13, angle = 0),
               axis.text.y = element_text(size = 13, angle = 0),  
               axis.title.x=element_blank(),
               axis.title.y=element_blank(),
               plot.title = element_text(size = 13, face = "bold",hjust = 0.5),
                  #legend.position = "none"
             )
box1


```

And then remove any samples that are 3 standard deviations from the mean. 

```{r outliers6, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}


#outliers
#des.3 <- Hmisc::describe(df_phenos[,c("R_AVG","L_AVG","Both_AVG")]) 
des.1 <- pastecs::stat.desc(gm$covar[,c("age.of.onset" ,"rz.age")]) 
des.2 <- psych::describe(gm$covar[,c("age.of.onset" ,"rz.age")]) 

#scale(df_phenos[,c("R_AVG")])

gm$covar$out.age.of.onset <- ifelse(gm$covar[,c("age.of.onset")] > (des.1[9,1] + 3*des.1[13,1])  | gm$covar[,c("age.of.onset")] < (des.1[9,1] - 3*des.1[13,1]), 'Outlier','Keep')
gm$covar$out.rz.age <- ifelse(gm$covar[,c("rz.age")] > (des.1[9,2] + 3*des.1[13,2])  | gm$covar[,c("rz.age")] < (des.1[9,2] - 3*des.1[13,2]), 'Outlier','Keep')

bad <- NULL
bad$Mouse.ID <- rownames(gm$covar)
bad$age.of.onset <- ifelse(gm$covar$out.age.of.onset =="Outlier", 'XX', '')
bad$rz.age <- ifelse(gm$covar$out.rz.age =="Outlier", 'XX', '')
bad[is.na(bad)] <- ""
bad[bad=='NA'] <- ""
df <- do.call(cbind, bad)
bad <- as.data.frame(df)

badind <- subset(bad, 
         bad$age.of.onset == 'XX'|
         bad$rz.age == 'XX')


#badind <- bad[bad$no_pheno == 'XX',]

badind[] <- lapply(badind, as.character)
#badind$Thaiss_ID <- ifelse(badind$Thaiss == 994 | badind$Thaiss == 995 | badind$Thaiss == 996 |badind$Thaiss == 997 | badind$Thaiss == 998 | badind$Thaiss == 999, "--", bad$Thaiss_ID)

rownames(badind) <- NULL

badind[] %>% 
   dplyr::mutate(
     age.of.onset = ifelse(age.of.onset == 'XX',
                  cell_spec(age.of.onset, color = 'gray',background = 'gray'),
                  ''),
     rz.age = ifelse(rz.age == 'XX',
                  cell_spec(rz.age, color = 'gray',background = 'gray'),
                  '')
     ) %>%
   kable(escape = F,align = c("ccccccccc"),linesep ="\\hline") %>%
   kable_styling("striped", full_width = F) #%>%
#   column_spec(1:3, width = "3cm") 


##removing outliers
gm$covar$Mouse.ID <- rownames(gm$covar)
write.csv(gm$covar,"data/covar_corrected_het-ici.vs.het-pbs_7.batches_myo_mis.csv", row.names=T, quote=F)

gm$covar$age.of.onset[gm$covar$out.age.of.onset == "Outlier"] <- '' 
gm$covar$rz.age[gm$covar$out.rz.age == "Outlier"] <- '' 

#gm$covar <- gm$covar[c(1:15)]
#gm$covar$id <- rownames(gm$covar)
write.csv(gm$covar,"data/covar_corrected.cleaned_het-ici.vs.het-pbs_7.batches_myo_mis.csv", row.names=T, quote=F)

```

### Hetero: ICI Myocarditis Yes vs ICI Myocarditis No
* Myocarditis Status: Yes, No
* Murine MHC KO Status: Het
* Drug Treatment(s): ICI
* Clinical Phenotype(s): Sick, EOI
* Covariates (Myocarditis Score)

```{r Phenotype distribution7, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}

gm=gm_allqc

##extracting animals 
#Myocarditis Status
miceinfo <- gm$covar[gm$covar$"Myocarditis Status" == "YES" | gm$covar$"Myocarditis Status" == "NO",]
#table(miceinfo$group)
#MMurine MHC KO Status
miceinfo <- miceinfo[miceinfo$"Murine MHC KO Status" == "HET",]
#Drug Treatment
miceinfo <- miceinfo[miceinfo$"Drug Treatment" == "ICI",]
#Clinical Phenotype
miceinfo <- miceinfo[miceinfo$"clinical pheno" == "SICK" | miceinfo$"clinical pheno" == "EOI",]

table(miceinfo$"Myocarditis Status")
table(miceinfo$"Murine MHC KO Status")
table(miceinfo$"Drug Treatment")
table(miceinfo$"clinical pheno")

mice.ids <- rownames(miceinfo)

##removing X samples
x.samples = c("NM00179-ICI-EOI","NM00186-ICI-EOI","D22-ICI-EOI","D39-ICI-Myo","D67-ICI-Myo","D111-PBS-Myo","D120-ICI-Myo","6895-PBS-Myo","D704-ICI-Myo")
mice.ids = mice.ids[!as.character(do.call(rbind.data.frame, strsplit(mice.ids, "_"))[,7]) %in% x.samples]

#removing duplicates
dup.samples = c("The_Jackson_Lab_Serreze_MURGIGV01_20230225_D249-PBS-EOI_H3")
mice.ids = mice.ids[!mice.ids %in% dup.samples]

gm <- gm[mice.ids]
gm

pr.qc <- pr
for (i in 1:20){pr.qc[[i]] = pr.qc[[i]][mice.ids,,]}

gm$covar$het.ici.myo.yes_vs_het.ici.myo.no <- ifelse(gm$covar$"Myocarditis Status" == "YES", 0, 1)
names(gm$covar)[6] <- c("age.of.onset")
gm$covar$age.of.onset <- as.numeric(gm$covar$age.of.onset)
gm$covar[gm$covar$age.of.onset==0 | is.na(gm$covar$age.of.onset) | gm$covar$age.of.onset=="NA" ,]$age.of.onset = ""
gm$covar[gm$covar$age.of.onset=='' ,]$age.of.onset <- 40
gm$covar$age.of.onset <- as.numeric(gm$covar$age.of.onset)

p <- ggplot(gm$covar, aes(x=as.numeric(age.of.onset))) + geom_histogram(color="black", fill="white")
p

phenos.covars.lg <- gm$covar %>% gather(variable, value, -c("id","sex","sex_pheno","Inferred.Sex","Myocarditis Status","clinical pheno","Drug Treatment","Histology Score","Murine MHC KO Status","id_corrected","het.ici.myo.yes_vs_het.ici.myo.no"))

box1 <-  ggplot(data=phenos.covars.lg, aes(x=variable, y=as.numeric(value), color=interaction("Myocarditis Status","Drug Treatment","clinical pheno"), fill=interaction("Myocarditis Status","Drug Treatment","clinical pheno"))) +
         geom_boxplot(position = position_dodge(width=0.9)) +
         #ggtitle(paste0("Values of ",v," [random dataframe: ",r,"]")) +
         #labs(y = v) +
         theme(strip.text.x = element_text(size=13),
               axis.text.x = element_text(size = 13, angle = 0),
               axis.text.y = element_text(size = 13, angle = 0),  
               axis.title.x=element_blank(),
               axis.title.y=element_blank(),
               plot.title = element_text(size = 13, face = "bold",hjust = 0.5),
                  #legend.position = "none"
             )
box1


```
QTL analysis requires variables follow normal distribution, from the above distributions, we need to ranknorm the data.  


```{r Phenotype distribution27, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}

##ranknorm
rz.transform <- function(y) {
  rankY=rank(y, ties.method="average", na.last="keep")
  rzT=qnorm(rankY/(length(na.exclude(rankY))+1))
  return(rzT)
}

gm$covar$rz.age <- rz.transform(gm$covar$age.of.onset)

p <- ggplot(gm$covar, aes(x=as.numeric(rz.age))) + geom_histogram(color="black", fill="white")
p

phenos.covars.lg <- gm$covar %>% gather(variable, value, -c("id","sex","sex_pheno","Inferred.Sex","Myocarditis Status","clinical pheno","Drug Treatment","Histology Score","Murine MHC KO Status","id_corrected","het.ici.myo.yes_vs_het.ici.myo.no","age.of.onset"))

box1 <-  ggplot(data=phenos.covars.lg, aes(x=variable, y=as.numeric(value), color=interaction("Myocarditis Status","Drug Treatment","clinical pheno"), fill=interaction("Myocarditis Status","Drug Treatment","clinical pheno"))) +
         geom_boxplot(position = position_dodge(width=0.9)) +
         #ggtitle(paste0("Values of ",v," [random dataframe: ",r,"]")) +
         #labs(y = v) +
         theme(strip.text.x = element_text(size=13),
               axis.text.x = element_text(size = 13, angle = 0),
               axis.text.y = element_text(size = 13, angle = 0),  
               axis.title.x=element_blank(),
               axis.title.y=element_blank(),
               plot.title = element_text(size = 13, face = "bold",hjust = 0.5),
                  #legend.position = "none"
             )
box1


```

And then remove any samples that are 3 standard deviations from the mean. 

```{r outliers7, fig.height = 6, fig.width = 9.5, fig.align = "center", echo=TRUE}


#outliers
#des.3 <- Hmisc::describe(df_phenos[,c("R_AVG","L_AVG","Both_AVG")]) 
des.1 <- pastecs::stat.desc(gm$covar[,c("age.of.onset" ,"rz.age")]) 
des.2 <- psych::describe(gm$covar[,c("age.of.onset" ,"rz.age")]) 

#scale(df_phenos[,c("R_AVG")])

gm$covar$out.age.of.onset <- ifelse(gm$covar[,c("age.of.onset")] > (des.1[9,1] + 3*des.1[13,1])  | gm$covar[,c("age.of.onset")] < (des.1[9,1] - 3*des.1[13,1]), 'Outlier','Keep')
gm$covar$out.rz.age <- ifelse(gm$covar[,c("rz.age")] > (des.1[9,2] + 3*des.1[13,2])  | gm$covar[,c("rz.age")] < (des.1[9,2] - 3*des.1[13,2]), 'Outlier','Keep')

bad <- NULL
bad$Mouse.ID <- rownames(gm$covar)
bad$age.of.onset <- ifelse(gm$covar$out.age.of.onset =="Outlier", 'XX', '')
bad$rz.age <- ifelse(gm$covar$out.rz.age =="Outlier", 'XX', '')
bad[is.na(bad)] <- ""
bad[bad=='NA'] <- ""
df <- do.call(cbind, bad)
bad <- as.data.frame(df)

badind <- subset(bad, 
         bad$age.of.onset == 'XX'|
         bad$rz.age == 'XX')


#badind <- bad[bad$no_pheno == 'XX',]

badind[] <- lapply(badind, as.character)
#badind$Thaiss_ID <- ifelse(badind$Thaiss == 994 | badind$Thaiss == 995 | badind$Thaiss == 996 |badind$Thaiss == 997 | badind$Thaiss == 998 | badind$Thaiss == 999, "--", bad$Thaiss_ID)

rownames(badind) <- NULL

badind[] %>% 
   dplyr::mutate(
     age.of.onset = ifelse(age.of.onset == 'XX',
                  cell_spec(age.of.onset, color = 'gray',background = 'gray'),
                  ''),
     rz.age = ifelse(rz.age == 'XX',
                  cell_spec(rz.age, color = 'gray',background = 'gray'),
                  '')
     ) %>%
   kable(escape = F,align = c("ccccccccc"),linesep ="\\hline") %>%
   kable_styling("striped", full_width = F) #%>%
#   column_spec(1:3, width = "3cm") 


##removing outliers
gm$covar$Mouse.ID <- rownames(gm$covar)
write.csv(gm$covar,"data/covar_corrected_het-ici-myo-yes.vs.het-ici-myo-no_7.batches_myo_mis.csv", row.names=T, quote=F)

gm$covar$age.of.onset[gm$covar$out.age.of.onset == "Outlier"] <- '' 
gm$covar$rz.age[gm$covar$out.rz.age == "Outlier"] <- '' 

#gm$covar <- gm$covar[c(1:15)]
#gm$covar$id <- rownames(gm$covar)
write.csv(gm$covar,"data/covar_corrected.cleaned_het-ici-myo-yes.vs.het-ici-myo-no_7.batches_myo_mis.csv", row.names=T, quote=F)

```


